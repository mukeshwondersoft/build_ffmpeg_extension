name: Build FFmpeg for Android

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up NDK
      run: |
        mkdir -p android-ndk
        curl -L https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -o ndk.zip
        unzip -q ndk.zip -d android-ndk
        rm ndk.zip
        echo "NDK_PATH=$(pwd)/android-ndk/android-ndk-r25c" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool pkg-config nasm

    - name: Build armeabi-v7a
      run: |
        cd ffmpeg
        ./configure \
          --prefix=./output/armeabi-v7a \
          --target-os=android \
          --arch=arm \
          --cpu=armv7-a \
          --enable-static \
          --disable-shared \
          --cross-prefix="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-" \
          --nm="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm" \
          --ar="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" \
          --ranlib="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
          --strip="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" \
          --extra-cflags="-march=armv7-a -mfloat-abi=softfp" \
          --extra-ldflags="-Wl,--fix-cortex-a8" \
          --disable-doc \
          --disable-programs \
          --disable-everything \
          --disable-avdevice \
          --enable-avformat \
          --enable-swscale \
          --disable-postproc \
          --disable-avfilter \
          --disable-symver \
          --enable-swresample \
          --disable-v4l2-m2m \
          --disable-vulkan \
          --enable-decoder=aac \
          --enable-decoder=mp3 \
          --enable-decoder=h264 \
          --enable-decoder=hevc \
          --enable-decoder=vp8 \
          --enable-decoder=vp9 \
          --enable-decoder=flac \
          --enable-decoder=opus \
          --enable-decoder=vorbis

        make -j$(nproc)
        make install
        make clean

    - name: Build arm64-v8a
      run: |
        cd ffmpeg
        ./configure \
          --prefix=./output/arm64-v8a \
          --target-os=android \
          --arch=aarch64 \
          --cpu=armv8-a \
          --enable-static \
          --disable-shared \
          --cross-prefix="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-" \
          --nm="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm" \
          --ar="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" \
          --ranlib="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
          --strip="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" \
          --disable-doc \
          --disable-programs \
          --disable-everything \
          --disable-avdevice \
          --enable-avformat \
          --enable-swscale \
          --disable-postproc \
          --disable-avfilter \
          --disable-symver \
          --enable-swresample \
          --disable-v4l2-m2m \
          --disable-vulkan \
          --enable-decoder=aac \
          --enable-decoder=mp3 \
          --enable-decoder=h264 \
          --enable-decoder=hevc \
          --enable-decoder=vp8 \
          --enable-decoder=vp9 \
          --enable-decoder=flac \
          --enable-decoder=opus \
          --enable-decoder=vorbis

        make -j$(nproc)
        make install
        make clean

    - name: Build x86
      run: |
        cd ffmpeg
        ./configure \
          --prefix=./output/x86 \
          --target-os=android \
          --arch=x86 \
          --cpu=i686 \
          --enable-static \
          --disable-shared \
          --cross-prefix="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-" \
          --nm="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm" \
          --ar="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" \
          --ranlib="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
          --strip="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" \
          --disable-asm \
          --disable-doc \
          --disable-programs \
          --disable-everything \
          --disable-avdevice \
          --enable-avformat \
          --enable-swscale \
          --disable-postproc \
          --disable-avfilter \
          --disable-symver \
          --enable-swresample \
          --disable-v4l2-m2m \
          --disable-vulkan \
          --enable-decoder=aac \
          --enable-decoder=mp3 \
          --enable-decoder=h264 \
          --enable-decoder=hevc \
          --enable-decoder=vp8 \
          --enable-decoder=vp9 \
          --enable-decoder=flac \
          --enable-decoder=opus \
          --enable-decoder=vorbis

        make -j$(nproc)
        make install
        make clean

    - name: Build x86_64
      run: |
        cd ffmpeg
        ./configure \
          --prefix=./output/x86_64 \
          --target-os=android \
          --arch=x86_64 \
          --cpu=x86-64 \
          --enable-static \
          --disable-shared \
          --cross-prefix="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-" \
          --nm="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm" \
          --ar="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" \
          --ranlib="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
          --strip="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" \
          --disable-asm \
          --disable-doc \
          --disable-programs \
          --disable-everything \
          --disable-avdevice \
          --enable-avformat \
          --enable-swscale \
          --disable-postproc \
          --disable-avfilter \
          --disable-symver \
          --enable-swresample \
          --disable-v4l2-m2m \
          --disable-vulkan \
          --enable-decoder=aac \
          --enable-decoder=mp3 \
          --enable-decoder=h264 \
          --enable-decoder=hevc \
          --enable-decoder=vp8 \
          --enable-decoder=vp9 \
          --enable-decoder=flac \
          --enable-decoder=opus \
          --enable-decoder=vorbis

        make -j$(nproc)
        make install
        make clean

    - name: Package artifacts
      run: |
        mkdir -p artifacts
        cd ffmpeg/output
        tar -czvf ../../artifacts/ffmpeg-android-libs.tar.gz *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-android-libs
        path: artifacts/ffmpeg-android-libs.tar.gz
